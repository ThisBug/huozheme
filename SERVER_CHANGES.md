# 服务端逻辑变更需求 (v1.5)

为了移除客户端对第三方邮件服务 (EmailJS) 的依赖，并优化通知流程，需要对服务端进行以下调整。

## 1. 新增 API Endpoint: 自我预警通知

需要创建一个新的 API 端点，允许客户端在特定条件下请求服务端向用户自己发送预警邮件。

-   **Endpoint**: `POST /api/v1/switch/notify-self`
-   **认证**: 需要标准的 `Authorization: Bearer <token>` Header。
-   **请求体 (Body)**: 无需 Body 内容。
-   **核心逻辑**:
    1.  服务端通过请求中的 JWT Token 和 `X-Device-UUID` 识别用户身份。
    2.  从数据库中查询该用户的 `meta.user_email`。(客户端逻辑已确保此字段在服务激活时必然存在)。
    3.  如果 `user_email` 存在，服务端将通过自己的邮件系统向该地址发送一封预警邮件。
-   **邮件内容模板 (建议)**:
    -   **主题**: `【活着么预警】您的生存确认即将超时`
    -   **正文**:
        ```
        尊敬的 [用户名],

        您的“活着么”生命周期计时器即将在 30 分钟后归零。

        为避免服务协议被触发，请尽快打开 App 进行签到。

        活着么 (Living Well)
        ```
-   **响应**:
    -   `200 OK`: 请求成功，邮件已加入发送队列。
    -   `404 Not Found`: 用户未设置邮箱。
    -   `429 Too Many Requests`: 如果需要，可以增加速率限制，例如每个周期只允许调用一次。

## 2. 核心通知逻辑变更

**当前逻辑**: 客户端发送心跳续期，服务端仅负责在倒计时结束后，根据存储的配置（联系人、备忘录）执行通知。

**新逻辑**:
1.  **用户本人预警 (T - 30分钟)**:
    -   **触发方**: **客户端**。
    -   **动作**: 当客户端计算出倒计时剩余 30 分钟时，会首先发送本地应用内通知。若服务已激活，则会调用新增的 `POST /api/v1/switch/notify-self` 接口。服务端负责发送邮件。

2.  **紧急联系人通知 (T = 0)**:
    -   **触发方**: **服务端**。
    -   **动作**: 当服务端内部的 Dead Man's Switch 计时器**完全归零**时，服务端自动触发此逻辑。
    -   服务端查询用户的【紧急联系人】列表，并向他们发送预警邮件/短信。

3.  **资产对接人通知 (T = 0 + Grace Period)**:
    -   **触发方**: **服务端**。
    -   **动作**: 当一级警报发出后，服务端开始内部的“确认延迟期 (Grace Period)”计时。该计时结束后，服务端自动触发此逻辑。
    -   服务端查询用户的【资产对接人】列表，并向他们发送包含【遗产备忘录】的邮件。

**总结**: 客户端的职责被简化为：**发送心跳** 和 **请求自我预警**。所有面向第三方联系人的、具有协议执行性质的通知，都必须由服务端在计时器到期后**独立、自动地触发**。
